<!-- Forms -->
<div class="row">
	<div class="col-md">
		<div class="card o-hidden border-0 shadow-sm my-5">
			<div class="card-body row">
				<!-- Register an account -->
				<div class="col-sm">
					<div class="text-center">
						<h6 class="text-gray-900 mb-4">
							Create an Account!
						</h6>
					</div>

					<form id="register-account-form">
						<!-- Register User ID -->
						<div class="form-group">
							<label for="reg-userID">
								User ID
							</label>
							<input type="text" class="form-control form-control-user" id="reg-userID"
								placeholder="Email Address" required>
							<div class="invalid-feedback">User ID is empty.</div>
						</div>

						<!-- Register User Password -->
						<div class="form-group">
							<label for="reg-password">
								Password
							</label>
							<input type="password" class="form-control form-control-user" id="reg-password"
								placeholder="Password" autocomplete="current-password" required>
							<div class="invalid-feedback">Password ID is empty.</div>
						</div>

						<!-- Register User SSN -->
						<div class="form-group">
							<label for="reg-SSN">
								SSN
							</label>
							<input type="number" class="form-control form-control-user" id="reg-SSN"
								placeholder="1234561234563" required>
							<div class="invalid-feedback">SSN ID is empty.</div>
						</div>

						<!-- Register User Comments -->
						<div class="form-group">
							<label for="reg-comment">
								Comment
							</label>
							<textarea type="text" class="form-control form-control-user" id="reg-comment"
								rows="1"></textarea>
						</div>

						<div class="form-group mt-4">
							<button class="btn btn-primary btn-user btn-block" type="submit"
								style="margin-top:1.84rem">Register Account</button>
						</div>
					</form>
				</div>

				<!-- Register Certificate -->
				<div class="col-sm">
					<div class="text-center">
						<h6 class="text-gray-900 mb-4">
							Register Certificate!
						</h6>
					</div>

					<form id="register-certificate-form">
						<!-- Register User ID -->
						<div class="form-group">
							<label for="regCert-userID">
								User ID
							</label>
							<input type="text" class="form-control form-control-user" id="regCert-userID"
								placeholder="Email Address" required>
							<div class="invalid-feedback">User ID is empty.</div>
						</div>

						<!-- Register User Password -->
						<div class="form-group">
							<label for="regCert-password">
								Password
							</label>
							<input type="password" class="form-control form-control-user" id="regCert-password"
								placeholder="Password" autocomplete="current-password" required>
							<div class="invalid-feedback">Password ID is empty.</div>
						</div>

						<div class="form-group">
							<button class="btn btn-primary btn-user btn-block" type="submit">Register
								Certificate</button>
						</div>
					</form>

					

					<div class="text-center">
						<h6 class="text-gray-900 mb-4">
							Login with the Certificate
						</h6>
					</div>

					<form id="cert-login-form">
						<!-- Register User ID -->
						<div class="form-group">
							<label for="login-userID">
								User ID
							</label>
							<input type="text" class="form-control form-control-user" id="login-userID"
								placeholder="Email Address" required>
							<div class="invalid-feedback">User ID is empty.</div>
						</div>

						<div class="form-group">
							<button class="btn btn-primary btn-user btn-block" type="submit">Login wtih
								Certificate</button>
						</div>
					</form>
				</div>
			</div>
		</div>

	</div>
	<!-- Database Table -->
	<div class="col-md">
		<div class="card o-hidden border-0 shadow-sm my-5">
			<div class="card-body">
				<div class="w-100">
					<h6 class="text-gray-900 mb-4">
						Database Sample
					</h6>
				</div>
				<table id="table-user" class="display" style="width: 100%;">
					<thead>
						<tr>
							<th>User ID</th>
							<th>Password</th>
							<th>SSN</th>
							<th>Cert. Serial Number</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- Data -->
<div class="row">
	<div class="text-center w-100">
		<button type="button" class="btn btn-outline-primary" onclick="toggleLogs();">Show More Details</button>
	</div>

	<div class="wrapper-logs w-100 d-none">
		<!-- Register User Logs -->
		<div class="col-md">
			<div class="card o-hidden border-0 shadow-sm my-5">
				<div class="card-header">User Registration Logs</div>
				<div class="card-body">
					<ul class="mb-0 pl-2 logs" id="user-registration-logs"></ul>
				</div>
			</div>

		</div>

		<!-- Register Certificate Logs -->
		<div class="col-md">
			<div class="card o-hidden border-0 shadow-sm my-5">
				<div class="card-header">Certificates Registration Logs</div>
				<div class="card-body">
					<ul class="mb-0 pl-2 logs" id="cert-registration-logs"></ul>
				</div>
			</div>

		</div>

		<!-- Login with the Certificate Logs -->
		<div class="col-md">
			<div class="card o-hidden border-0 shadow-sm my-5">
				<div class="card-header">Login with the Certificate Logs</div>
				<div class="card-body">
					<ul class="mb-0 pl-2 logs" id="cert-login-logs">

					</ul>
				</div>
			</div>
		</div>
	</div>
</div>


<script>
	var serverCert = "-----BEGIN CERTIFICATE-----MIIFyzCCBLOgAwIBAgIEBVo2TTANBgkqhkiG9w0BAQsFADBKMQswCQYDVQQGEwJLUjENMAsGA1UECgwES0lDQTEVMBMGA1UECwwMQWNjcmVkaXRlZENBMRUwEwYDVQQDDAxzaWduR0FURSBDQTUwHhcNMjAwNjE3MDAyMjEwWhcNMjEwNzA4MTQ1OTU5WjCBkjELMAkGA1UEBhMCS1IxDTALBgNVBAoMBEtJQ0ExEzARBgNVBAsMCmxpY2Vuc2VkQ0ExFTATBgNVBAsMDOuTseuhneq4sOq0gDEZMBcGA1UECwwQS0lDQeqzoOqwneyEvO2EsDERMA8GA1UECwwI7IS87YSwUkExGjAYBgNVBAMMEe2VnOygleyduCjqsJzsnbgpMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhk4R6nSzx2X4Kt751CtXj5oQOunvKXhzrieivDXc5qQviLMR+w6IqXHC/Z6q1jOagdArH9AQmKnD/26Tnhgud9jDVDmBaUns61scQ4GBD6VpkBtVsPe439nXOmsGU3ZLgf31YQfECzBk8zroWCvrsFFQC4uR3tkV768GQm6OwBk38JMPjJpqyZLR0ZzQJqBcepkI5iqmD+rYsMkm4HmLZY618egGP6mGGTmy9/l7xFGS2RiwSb7vtMLY/U94PkOR5XtQwH/k6EKfoZRTItDoRqsZKHpo189+rQExeBAC+748QK+Y+Yom/yYJda5MJgw7w1k4RIfwr0iXKWWgp8mLjQIDAQABo4ICbjCCAmowgY8GA1UdIwSBhzCBhIAU2L467EWZxZ7jnOqBH9IdErA2PoihaKRmMGQxCzAJBgNVBAYTAktSMQ0wCwYDVQQKDARLSVNBMS4wLAYDVQQLDCVLb3JlYSBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eSBDZW50cmFsMRYwFAYDVQQDDA1LSVNBIFJvb3RDQSA0ggIQHTAdBgNVHQ4EFgQU/0odTZLJLQDtHlB+IhMY3lRtzCMwDgYDVR0PAQH/BAQDAgbAMHUGA1UdIARuMGwwagYKKoMajJpEBQIBAjBcMCwGCCsGAQUFBwIBFiBodHRwOi8vd3d3LnNpZ25nYXRlLmNvbS9jcHMuaHRtbDAsBggrBgEFBQcCAjAgHh7HdAAgx3jJncEcspQAIKz1x3jHeMmdwRzHhbLIsuQwgYgGA1UdEQSBgDB+gRVwdXJlMjcxM0BzaWduZ2F0ZS5jb22gZQYJKoMajJpECgEBoFgwVgwR7ZWc7KCV7J24KOqwnOyduCkwQTA/BgoqgxqMmkQKAQEBMDEwCwYJYIZIAWUDBAIBoCIEIAD0qdxBiV9bf4u4z0VtZWhXZAvsZyLJVMIgOYESyjm6MF8GA1UdHwRYMFYwVKBSoFCGTmxkYXA6Ly9sZGFwLnNpZ25nYXRlLmNvbTozODkvb3U9ZHA3cDIyNzk5LG91PWNybGRwLG91PUFjY3JlZGl0ZWRDQSxvPUtJQ0EsYz1LUjBEBggrBgEFBQcBAQQ4MDYwNAYIKwYBBQUHMAGGKGh0dHA6Ly9vY3NwLnNpZ25nYXRlLmNvbTo5MDIwL09DU1BTZXJ2ZXIwDQYJKoZIhvcNAQELBQADggEBABrkL9RsgVGNRjX7CIUFULklx6IOAFaSIEZUZsxtX1l3w3thW0GUnt4hXvN7RD4pqVxAgxiVJaU/jRqTUTUIxgpOGPRpQzlR7cfbBotAZI7R9WesIaUV/gAucTMIv1qNBDn9Bd9S68A49raWE91zpMRLjkDqyjrL9MyFgQWsIFj06bxc7gj6lGO5XDEiFx5ISmDCEHuZjpP1oMl/mbOC4m1ktz2w6uIWY4y9fe9Znzi4OkT9KNUlZ7cXFBGC1ZW8QS0coEs+V4C0X2e27pJDKXDq/ioxy9/LWauNNNaBvowwt3BXb687zsunDn7XWqu6KKekeVgZU8fzJdI6cRjK/p4=-----END CERTIFICATE-----";


	function User(userID, password, SSN, comment) {
		this.userID = userID;
		this.password = password;
		this.SSN = SSN;
		this.comment = comment;
		this.certSerial = "";
		this.certPem = "";
	};


	$(document).ready(function () {
		var userTable = $('#table-user').DataTable({
			paging: false,
			scrollY: 402,
			searching: false,
			ordering: false,
			"autoWidth": false,
			responsive: true,


			data: [
				new User('kica@signgate.com', 'signgate1!', '1234561234563', 'Personal User'),
				new User('tech@signgate.com', 'signgate1!', '1111111119', 'Business User')
			],

			columns: [
				{ data: 'userID' },
				{ data: 'password' },
				{ data: 'SSN' },
				{ data: 'certSerial' }
			]
		});


		// register user form submit
		$('#register-account-form').submit(function (event) {
			event.preventDefault();

			var userID = $('#reg-userID').val();
			var password = $('#reg-password').val();
			var SSN = $('#reg-SSN').val();
			var comment = $('#reg-comment').val();

			// get user information from database.
			var userList = userTable.rows().data();

			for (var i = 0; i < userList.length; i++) {
				if (userList[i].userID === userID) {
					alert("The User ID is already registered.");
					// make logs
					var log = document.createElement('li');
					log.className = "text-danger";
					log.innerHTML = 'The User ID (<b>' + userID + '</b>) is already registered.';
					document.getElementById('user-registration-logs').appendChild(log);

					// make popover avalibale.
					$('[data-toggle="popover"]').popover();
					return;
				}
			}

			// create user account and register it to database
			var user = new User(userID, password, SSN, comment);
			userList.push(user);
			userTable.row.add(user).draw(false);

			// make logs
			var log = document.createElement('li');
			log.className = "text-success";
			log.innerHTML = 'The User ID (<b>' + userID + '</b>) has been successfully registered. See this: <a class="text-primary font-weight-bold" role="button" data-toggle="popover" title="USER INFORMATION" data-content="' + JSON.stringify(user, undefined, 4).replace(/\"/g, "'") + '">USER INFORMATION</a>';
			document.getElementById('user-registration-logs').appendChild(log);

			// make popover avalibale.
			$('[data-toggle="popover"]').popover();
		});

		// register certificate form submit
		$('#register-certificate-form').submit(function (event) {
			event.preventDefault();

			var userID = $('#regCert-userID').val();
			var password = $('#regCert-password').val();

			// get user information from database.
			var userList = userTable.rows().data();

			// check the user is registered.
			for (var i = 0; i < userList.length; i++) {
				if (userList[i].userID === userID) {
					// do register certificate
					var user = userList[i];
					var SSN = user.SSN;

					// check password
					// For the real service, user verification is required.
					if (password !== user.password) {
						alert('The password is not valid.');
						// make logs
						var log = document.createElement('li');
						log.className = "text-danger";
						log.innerHTML = 'The password for  user ID (<b>' + userID + '</b>) is invalid';
						document.getElementById('cert-registration-logs').appendChild(log);

						// make popover avalibale.
						$('[data-toggle="popover"]').popover();
						return;
					}

					// Do verify SSN
					html5DialogApi.verifyVid(SSN, function (res, error) {
						if (error == undefined) {
							// Todo success.   
							if (res === false) {
								// The ssn is not valid.
								alert('Identification is failed, please check the certificate.');
								// make logs
								var log = document.createElement('li');
								log.className = "text-danger";
								log.innerHTML = 'User identification is failed, the SSN is not matched to the certificate.';
								document.getElementById('cert-registration-logs').appendChild(log);

								// make popover avalibale.
								$('[data-toggle="popover"]').popover();
								return;
							} else {
								// identification is succeed.
								// get certificate information.
								var certificate = html5Api.getWNCertInfo();
								var serial = certificate.serial;

								// store the certificate serial number to user table
								user.certSerial = serial;
								userTable.row(i).data(user).draw();

								// to register certificate is succeed.
								alert('The certificate registration has been succeed.')
								// make logs
								var log = document.createElement('li');
								log.className = "text-success";
								log.innerHTML = 'The user identification is succeed with the certificate (<a class="text-primary font-weight-bold" role="button" data-toggle="popover" title="CERTIFICATE INFORMATION" data-content="' + JSON.stringify(certificate, undefined, 4).replace(/\"/g, "'") + '">CERTIFICATE INFORMATION</a>).';
								document.getElementById('cert-registration-logs').appendChild(log);

								// make popover avalibale.
								$('[data-toggle="popover"]').popover();
							}

							// Close the certificates selections dialgo.
							KICA_DIALOG.closeSelectCertificateDialog();
						} else {
							alert(error);
							// Todo error
						}
					})
					return;
				}
			}

			// the user is not registered.
			alert('The user ID is not registered.');
			// make logs
			var log = document.createElement('li');
			log.className = "text-danger";
			log.innerHTML = 'The User ID (<b>' + userID + '</b>) is not registered.';
			document.getElementById('cert-registration-logs').appendChild(log);

			// make popover avalibale.
			$('[data-toggle="popover"]').popover();
		});


		// Login with the certificate
		$('#cert-login-form').submit(function (event) {
			event.preventDefault();

			var userID = $('#login-userID').val();

			// get user information from database.
			var userList = userTable.rows().data();

			// generate login signautre
			var message = JSON.stringify({
				clientInfo: JSON.stringify({
					appCodeName: navigator.appCodeName,
					appVersion: navigator.appVersion,
					userAgent: navigator.userAgent,
					vendor: navigator.vendor,
				}).replace(/\"/g, "'"),
				userID: userID,
				date: Date(),
			});

			// options for signing
			var options = {
				charset: "euckr", // 'euckr' | 'utf8' (default: euckr)
				digestAlg: "sha256", // 'sha1' | 'sha256' | 'sha512' (default: 인증서 서명에 사용한 해쉬 알고리즘)
				outputEncoding: "base64" // 'hex' | 'base64' (default: base64)
			};

			html5DialogApi.signedAndEnvelop(serverCert, message, options, function (res, error) {
				if (error === undefined) {
					// Todo for server validation.

					// temporary codes to demonstrate server validation,
					// get user account information
					var user;
					var userList = userTable.rows().data();

					for (var i = 0; i < userList.length; i++) {
						if (userID === userList[i].userID) {
							user = userList[i];
						}
					}

					// if the user is not registered.
					if (user === undefined) {
						alert('The user ID is not registered.');
						// make logs
						var log = document.createElement('li');
						log.className = "text-danger";
						log.innerHTML = 'The User ID (<b>' + userID + '</b>) is not registered.';
						document.getElementById('cert-login-logs').appendChild(log);

						// make popover avalibale.
						$('[data-toggle="popover"]').popover();
					} else {
						// Todo Verify enveloped message to get the signature.
						//pass

						// temporarily get certificate information of in the signature. 
						var certificate = html5Api.getWNCertInfo();

						// Compare the certificate is same with the certificate in the signature.
						// In this case, compare serial number.
						// if serial of the certificates is same.
						if (certificate.serial === user.certSerial) {
							alert("Login is succeed.");
							// make logs
							var log = document.createElement('li');
							log.className = "text-success";
							log.innerHTML = 'The login for (<b>' + userID + '</b>) is succeed. The signed enveloped message: <a class="text-primary font-weight-bold" role="button" data-toggle="popover" title="SIGNED AND ENVELOPED MESSAGE" data-content="' + res + '">SIGNED AND ENVELOPED MESSAGE</a>.';
							document.getElementById('cert-login-logs').appendChild(log);

							// make popover avalibale.
							$('[data-toggle="popover"]').popover();
						} else {
							if (user.certSerial === undefined || user.certSerial === "") {
								alert("There is no certificate registered in your account.");
								// make logs
								var log = document.createElement('li');
								log.className = "text-danger";
								log.innerHTML = 'There is no certificate registered in your account.';
								document.getElementById('cert-login-logs').appendChild(log);

								// make popover avalibale.
								$('[data-toggle="popover"]').popover();

							} else {
								alert("No certificates which match with your account.");
								// make logs
								var log = document.createElement('li');
								log.className = "text-danger";
								log.innerHTML = 'The certificate is same with the registered certificate, the serial number of registered certificate is <b>' + user.certSerial + '</b>';
								document.getElementById('cert-login-logs').appendChild(log);

								// make popover avalibale.
								$('[data-toggle="popover"]').popover();
							}
							return;
						}
					}

					// Close the certificates selections dialgo.
					KICA_DIALOG.closeSelectCertificateDialog();
				} else {
					// Todo for error
					alert(error);
				}
			})
		});
	});


	function toggleLogs() {
		var wrapperLogs = $('.wrapper-logs');

		if (wrapperLogs.hasClass('d-none'))
			$('.wrapper-logs').removeClass('d-none');
		else
			$('.wrapper-logs').addClass('d-none');
	}

	function syntaxHighlight(json) {
		json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
			var cls = 'number';
			if (/^"/.test(match)) {
				if (/:$/.test(match)) {
					cls = 'key';
				} else {
					cls = 'string';
				}
			} else if (/true|false/.test(match)) {
				cls = 'boolean';
			} else if (/null/.test(match)) {
				cls = 'null';
			}
			return '<span class="' + cls + '">' + match + '</span>';
		});
	}
</script>